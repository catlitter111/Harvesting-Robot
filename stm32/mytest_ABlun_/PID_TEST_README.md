# STM32四轮小车PID控制测试系统

## 系统概述
本系统基于STM32F103实现四轮独立PID速度控制，集成编码器反馈、串口通信和自动化测试功能。

## PID控制器分析

### 实现特点
- ✅ 支持位置式和增量式PID两种模式
- ✅ 四轮独立控制，每轮独立PID参数
- ✅ 积分限幅防止积分饱和
- ✅ 输出限幅保护电机
- ✅ 编码器速度反馈闭环控制
- ⚠️ 已修复增量式PID实现问题

### 配置参数
```c
#define PID_KP_DEFAULT 2.0f    // 比例系数
#define PID_KI_DEFAULT 0.1f    // 积分系数  
#define PID_KD_DEFAULT 0.5f    // 微分系数
#define PID_SAMPLE_TIME 20     // 采样周期(ms)
```

## 测试功能

### 自动测试模式
1. **前进测试** - 3秒直线前进
2. **后退测试** - 3秒直线后退  
3. **左转测试** - 2秒边行边左转
4. **转圈测试** - 5秒原地转圈
5. **加速急停** - 1秒加速到50%后急停
6. **序列测试** - 自动执行所有测试

### 串口控制命令

#### PID测试命令 (0x06)
```
帧格式: AA 55 06 02 [模式] [速度] [校验和]
模式:
  0 - 停止测试
  1 - 前进测试
  2 - 后退测试  
  3 - 左转测试
  4 - 转圈测试
  5 - 加速急停测试
  6 - 序列测试
速度: 10-100 (百分比)
```

#### PID参数设置 (0x07)
```
帧格式: AA 55 07 0C [Kp(4字节)] [Ki(4字节)] [Kd(4字节)] [校验和]
参数为IEEE754浮点数格式
```

### 数据输出格式
```
[PID_DATA]设定:30,30,30,30|实际:28,31,29,30|PWM:85,82,87,83
```
- 设定: 四轮目标速度
- 实际: 编码器测量速度  
- PWM: PID输出值

## 使用方法

### 1. 硬件连接
- 编码器连接到GPIOC 0-7引脚
- 电机驱动连接到TIM1 PWM输出
- 串口2用于调试和控制(115200波特率)

### 2. 软件调用
```c
// 初始化
PID_Test_Init();

// 启动测试
PID_Test_Start(PID_TEST_FORWARD, 30);

// 手动控制四轮
PID_Test_Manual_Control(30, -30, 30, -30);

// 调整PID参数
Robot_Set_PID_Params(2.5f, 0.15f, 0.6f);
```

### 3. 串口测试示例
```python
# Python测试脚本示例
import serial

ser = serial.Serial('COM3', 115200)

# 前进测试，速度30%
cmd = [0xAA, 0x55, 0x06, 0x02, 0x01, 0x1E]
checksum = sum(cmd[2:]) & 0xFF
cmd.append(checksum)
ser.write(bytes(cmd))
```

## 调试信息
系统通过串口输出详细调试信息:
- PID计算过程
- 编码器读数
- 电机控制状态
- 测试进度

## 性能优化建议
1. 根据实际电机特性调整PID参数
2. 编码器滤波减少噪声影响
3. 适当的采样频率平衡性能和稳定性
4. 考虑前馈控制提高响应速度

## 故障排除
- 检查编码器连接和信号质量
- 验证电机驱动电路
- 确认串口通信参数
- 监控PID输出是否合理 