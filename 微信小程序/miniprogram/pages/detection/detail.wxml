<!--pages/detection/detail.wxml-->
<!--æ°´æœæ£€æµ‹è¯¦æƒ…é¡µé¢-->

<!-- å¼•å…¥å·¥å…·æ–¹æ³• -->
<wxs module="utils" src="./detail.wxs"></wxs>

<view class="detail-container">
  
  <!-- æ°´æœå›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
  <view class="fruit-image-section">
    <view class="image-container">
      <image wx:if="{{detectionData.imageUrl}}" 
             class="fruit-image" 
             src="{{detectionData.imageUrl}}" 
             mode="aspectFill"
             bindtap="previewImage">
      </image>
      <view wx:else class="image-placeholder">
        <text class="placeholder-emoji">{{detectionData.fruitEmoji || 'ğŸ'}}</text>
        <text class="placeholder-text">æš‚æ— å›¾ç‰‡</text>
      </view>
      
      <!-- å›¾ç‰‡æ ‡è¯† -->
      <view class="image-badges">
        <view wx:if="{{detectionData.isLocalImage}}" class="image-badge local">
          <text class="badge-text">æœ¬åœ°</text>
        </view>
        <view class="image-badge confidence">
          <text class="badge-text">{{detectionData.confidence}}%</text>
        </view>
      </view>
      
      <!-- å“è´¨ç­‰çº§å¾½ç«  -->
      <view class="grade-badge {{detectionData.grade ? detectionData.grade.toLowerCase() : 'average'}}">
        <text class="grade-text">{{detectionData.grade || 'Average'}}</text>
      </view>
    </view>
  </view>

  <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
  <view class="info-card basic-info">
    <view class="card-header">
      <text class="card-icon">ğŸ</text>
      <text class="card-title">åŸºæœ¬ä¿¡æ¯</text>
    </view>
    
    <view class="info-content">
      <view class="info-row main-info">
        <view class="fruit-identity">
          <text class="fruit-emoji">{{detectionData.fruitEmoji || 'ğŸ'}}</text>
          <view class="fruit-details">
            <text class="fruit-name">{{detectionData.fruitType || 'æœªçŸ¥æ°´æœ'}}</text>
            <text class="fruit-variety">{{detectionData.variety || 'æœªçŸ¥å“ç§'}}</text>
          </view>
        </view>
        <view class="detection-time">
          <text class="time-label">æ£€æµ‹æ—¶é—´</text>
          <text class="time-value">{{detectionData.detectionTime || '--:--'}}</text>
        </view>
      </view>
      
      <view class="info-row">
        <view class="info-item">
          <text class="info-label">æ£€æµ‹ä½ç½®</text>
          <text class="info-value">{{detectionData.location || 'æœªçŸ¥ä½ç½®'}}</text>
        </view>
      </view>
      
      <view class="info-row">
        <view class="info-item">
          <text class="info-label">æ“ä½œå»ºè®®</text>
          <view class="action-status {{utils.getActionStatusClass(detectionData.actionTaken)}}">
            <text class="status-text">{{detectionData.actionTaken || 'å¾…å¤„ç†'}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆç†Ÿåº¦åˆ†æå¡ç‰‡ -->
  <view class="info-card maturity-analysis">
    <view class="card-header">
      <text class="card-icon">ğŸŒ±</text>
      <text class="card-title">æˆç†Ÿåº¦åˆ†æ</text>
    </view>
    
    <view class="analysis-content">
      <view class="maturity-display">
        <view class="maturity-circle">
          <view class="circle-progress" style="background: conic-gradient(#4CAF50 0deg {{(detectionData.maturity || 0) * 3.6}}deg, #E0E0E0 {{(detectionData.maturity || 0) * 3.6}}deg 360deg);">
            <view class="circle-inner">
              <text class="maturity-percent">{{detectionData.maturity || 0}}%</text>
              <text class="maturity-label">æˆç†Ÿåº¦</text>
            </view>
          </view>
        </view>
        
        <view class="maturity-info">
          <view class="maturity-stage">
            <text class="stage-label">æˆç†Ÿé˜¶æ®µ</text>
            <text class="stage-value">{{utils.getMaturityStage(detectionData.maturity)}}</text>
          </view>
           
          <view wx:if="{{detectionData.ripeness_days !== undefined}}" class="ripeness-timing">
            <text class="timing-label">é‡‡æ‘˜æ—¶æœº</text>
            <text class="timing-value {{detectionData.ripeness_days === 0 ? 'optimal' : detectionData.ripeness_days > 0 ? 'wait' : 'overdue'}}">
              {{utils.getRipenessText(detectionData.ripeness_days)}}
            </text>
          </view>
        </view>
      </view>
      
      <!-- æˆç†Ÿåº¦å»ºè®® -->
      <view class="maturity-recommendation">
        <text class="recommendation-text">
          {{utils.getMaturityRecommendation(detectionData.maturity, detectionData.ripeness_days)}}
        </text>
      </view>
    </view>
  </view>

  <!-- å¥åº·çŠ¶å†µå¡ç‰‡ -->
  <view class="info-card health-status">
    <view class="card-header">
      <text class="card-icon">ğŸ¥</text>
      <text class="card-title">å¥åº·çŠ¶å†µ</text>
    </view>
    
    <view class="health-content">
      <view class="health-overview">
        <view class="health-indicator {{utils.getHealthLevel(detectionData.healthStatus)}}">
          <text class="health-icon">{{utils.getHealthIcon(detectionData.healthStatus)}}</text>
          <text class="health-text">{{detectionData.healthStatus || 'æœªçŸ¥'}}</text>
        </view>
      </view>
      
      <!-- ç¼ºé™·åˆ—è¡¨ -->
      <view wx:if="{{detectionData.defects && detectionData.defects.length > 0}}" class="defects-section">
        <text class="defects-title">å‘ç°çš„ç¼ºé™·</text>
        <view class="defects-list">
          <view class="defect-item" wx:for="{{detectionData.defects}}" wx:key="index">
            <text class="defect-icon">âš ï¸</text>
            <text class="defect-text">{{item}}</text>
          </view>
        </view>
      </view>
      
      <view wx:else class="no-defects">
        <text class="no-defects-icon">âœ…</text>
        <text class="no-defects-text">æœªå‘ç°æ˜æ˜¾ç¼ºé™·</text>
      </view>
    </view>
  </view>

  <!-- å“è´¨è¯„ä¼°å¡ç‰‡ -->
  <view class="info-card quality-assessment">
    <view class="card-header">
      <text class="card-icon">â­</text>
      <text class="card-title">å“è´¨è¯„ä¼°</text>
    </view>
    
    <view class="quality-content">
      <view class="quality-score-display">
        <view class="score-circle">
          <text class="score-number">{{detectionData.qualityScore || 0}}</text>
          <text class="score-label">åˆ†</text>
        </view>
        <view class="score-info">
          <text class="score-grade">{{utils.getQualityGrade(detectionData.qualityScore)}}</text>
          <view class="score-stars">
            <text class="star {{index < utils.getStarCount(detectionData.qualityScore) ? 'filled' : 'empty'}}" 
                  wx:for="{{[1,2,3,4,5]}}" wx:key="index">â˜…</text>
          </view>
        </view>
      </view>
      
      <view class="quality-breakdown">
        <view class="quality-item">
          <text class="quality-aspect">å¤§å°è§„æ ¼</text>
          <text class="quality-value">{{detectionData.sizeCategory || 'ä¸­ç­‰'}}</text>
        </view>
        <view class="quality-item">
          <text class="quality-aspect">å¤–è§‚è¯„çº§</text>
          <text class="quality-value">{{detectionData.grade || 'Average'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¸‚åœºä»·å€¼å¡ç‰‡ -->
  <view wx:if="{{detectionData.marketValue || detectionData.estimatedWeight}}" class="info-card market-value">
    <view class="card-header">
      <text class="card-icon">ğŸ’°</text>
      <text class="card-title">å¸‚åœºä»·å€¼</text>
    </view>
    
    <view class="market-content">
      <view class="value-display">
        <view wx:if="{{detectionData.marketValue}}" class="market-price">
          <text class="price-label">å¸‚åœºä»·æ ¼</text>
          <text class="price-value">Â¥{{detectionData.marketValue}}/æ–¤</text>
        </view>
        
        <view wx:if="{{detectionData.estimatedWeight}}" class="estimated-weight">
          <text class="weight-label">é¢„ä¼°é‡é‡</text>
          <text class="weight-value">{{detectionData.estimatedWeight}}å…‹</text>
        </view>
      </view>
      
      <view wx:if="{{detectionData.marketValue && detectionData.estimatedWeight}}" class="estimated-value">
        <text class="value-label">é¢„ä¼°å•æœä»·å€¼</text>
        <text class="value-amount">Â¥{{utils.calculateFruitValue(detectionData.marketValue, detectionData.estimatedWeight)}}</text>
      </view>
      
      <view wx:if="{{detectionData.storageLife}}" class="storage-info">
        <text class="storage-label">å‚¨å­˜æœŸé™</text>
        <text class="storage-value">{{detectionData.storageLife}}å¤©</text>
      </view>
    </view>
  </view>

  <!-- AIå»ºè®®å¡ç‰‡ -->
  <view class="info-card ai-recommendation">
    <view class="card-header">
      <text class="card-icon">ğŸ’¡</text>
      <text class="card-title">AIä¸“ä¸šå»ºè®®</text>
    </view>
    
    <view class="recommendation-content">
      <text class="recommendation-text">{{detectionData.recommendation || 'æš‚æ— å»ºè®®'}}</text>
      
      <!-- æ“ä½œå»ºè®® -->
      <view wx:if="{{detectionData.suggestedAction}}" class="action-suggestion">
        <text class="action-label">å»ºè®®æ“ä½œ</text>
        <view class="action-code {{detectionData.suggestedAction}}">
          <text class="action-text">{{utils.getActionText(detectionData.suggestedAction)}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ€æœ¯ä¿¡æ¯å¡ç‰‡ -->
  <view class="info-card technical-info">
    <view class="card-header">
      <text class="card-icon">ğŸ”¬</text>
      <text class="card-title">æŠ€æœ¯ä¿¡æ¯</text>
    </view>
    
    <view class="technical-content">
      <view class="tech-item">
        <text class="tech-label">è¯†åˆ«ç½®ä¿¡åº¦</text>
        <view class="confidence-bar">
          <view class="confidence-fill" style="width: {{detectionData.confidence || 0}}%"></view>
          <text class="confidence-text">{{detectionData.confidence || 0}}%</text>
        </view>
      </view>
      
      <view class="tech-item">
        <text class="tech-label">æ£€æµ‹æ¨¡å¼</text>
        <text class="tech-value">{{detectionData.detectionMode || 'ç»¼åˆæ£€æµ‹'}}</text>
      </view>
      
      <view class="tech-item">
        <text class="tech-label">æ•°æ®æ¥æº</text>
        <text class="tech-value">{{detectionData.isLocalImage ? 'æœ¬åœ°å›¾ç‰‡' : 'æœåŠ¡å™¨å›¾ç‰‡'}}</text>
      </view>
      
      <view class="tech-item">
        <text class="tech-label">æ£€æµ‹ID</text>
        <text class="tech-value tech-id">{{detectionData.id || 'æœªçŸ¥'}}</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
  <view class="action-buttons">
    <button class="action-btn secondary" bindtap="shareResult">
      <text class="btn-icon">ğŸ“¤</text>
      <text class="btn-text">åˆ†äº«ç»“æœ</text>
    </button>
    
    <button class="action-btn secondary" bindtap="saveToAlbum">
      <text class="btn-icon">ğŸ’¾</text>
      <text class="btn-text">ä¿å­˜å›¾ç‰‡</text>
    </button>
    
    <button class="action-btn primary" bindtap="reanalyze">
      <text class="btn-icon">ğŸ”„</text>
      <text class="btn-text">é‡æ–°åˆ†æ</text>
    </button>
  </view>

  <!-- åº•éƒ¨é—´è· -->
  <view class="bottom-spacing"></view>
</view>