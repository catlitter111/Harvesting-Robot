// pages/detection/detail.wxs
// è¯¦æƒ…é¡µé¢å·¥å…·å‡½æ•°

/**
 * è·å–æˆç†Ÿåº¦é˜¶æ®µæè¿°
 * @param {number} maturity - æˆç†Ÿåº¦ç™¾åˆ†æ¯”
 * @returns {string} æˆç†Ÿåº¦é˜¶æ®µ
 */
function getMaturityStage(maturity) {
    if (!maturity) return 'æœªçŸ¥';
    
    if (maturity <= 20) return 'å¹¼æœæœŸ';
    if (maturity <= 40) return 'ç”Ÿé•¿æœŸ';
    if (maturity <= 60) return 'è½¬è‰²æœŸ';
    if (maturity <= 80) return 'è¿‘ç†ŸæœŸ';
    if (maturity <= 95) return 'æœ€ä½³é‡‡æ‘˜æœŸ';
    return 'è¿‡ç†ŸæœŸ';
  }
  
  /**
   * è·å–é‡‡æ‘˜æ—¶æœºæ–‡æœ¬
   * @param {number} ripeness_days - é‡‡æ‘˜å¤©æ•°
   * @returns {string} é‡‡æ‘˜æ—¶æœºæè¿°
   */
  function getRipenessText(ripeness_days) {
    if (ripeness_days === undefined || ripeness_days === null) return 'æœªçŸ¥';
    
    if (ripeness_days === 0) return 'ç«‹å³é‡‡æ‘˜';
    if (ripeness_days > 0) return ripeness_days + 'å¤©åé‡‡æ‘˜';
    return 'å·²è¿‡æœ€ä½³æœŸ' + Math.abs(ripeness_days) + 'å¤©';
  }
  
  /**
   * è·å–æˆç†Ÿåº¦å»ºè®®
   * @param {number} maturity - æˆç†Ÿåº¦
   * @param {number} ripeness_days - é‡‡æ‘˜å¤©æ•°
   * @returns {string} å»ºè®®æ–‡æœ¬
   */
  function getMaturityRecommendation(maturity, ripeness_days) {
    if (!maturity) return 'æ— æ³•æä¾›å»ºè®®ï¼Œç¼ºå°‘æˆç†Ÿåº¦æ•°æ®';
    
    if (maturity >= 80 && maturity <= 95) {
      return 'æ°´æœå·²è¾¾åˆ°æœ€ä½³æˆç†Ÿåº¦ï¼Œå»ºè®®ç«‹å³é‡‡æ‘˜ä»¥è·å¾—æœ€ä½³å£æ„Ÿå’Œè¥å…»ä»·å€¼ã€‚';
    } else if (maturity > 95) {
      return 'æ°´æœå·²è¿‡åº¦æˆç†Ÿï¼Œå»ºè®®å°½å¿«é‡‡æ‘˜ï¼Œé€‚åˆç«‹å³é£Ÿç”¨æˆ–åŠ å·¥å¤„ç†ã€‚';
    } else if (maturity >= 60) {
      return 'æ°´æœæ¥è¿‘æˆç†Ÿï¼Œå»ºè®®ç»§ç»­è§‚å¯Ÿï¼Œé¢„è®¡å‡ å¤©å†…å¯è¾¾åˆ°æœ€ä½³é‡‡æ‘˜æœŸã€‚';
    } else if (maturity >= 40) {
      return 'æ°´æœæ­£åœ¨è½¬è‰²æœŸï¼Œéœ€è¦ç»§ç»­ç­‰å¾…æˆç†Ÿï¼Œå»ºè®®ä¸€å‘¨åé‡æ–°æ£€æµ‹ã€‚';
    } else {
      return 'æ°´æœå°šæœªæˆç†Ÿï¼Œéœ€è¦è¾ƒé•¿æ—¶é—´ç»§ç»­ç”Ÿé•¿ï¼Œå»ºè®®2-3å‘¨åé‡æ–°æ£€æµ‹ã€‚';
    }
  }
  
  /**
   * è·å–å¥åº·ç­‰çº§
   * @param {string} healthStatus - å¥åº·çŠ¶æ€
   * @returns {string} å¥åº·ç­‰çº§ç±»å
   */
  function getHealthLevel(healthStatus) {
    if (!healthStatus) return 'unknown';
    
    var status = healthStatus.toLowerCase();
    if (status.indexOf('å®Œå…¨å¥åº·') !== -1 || status.indexOf('excellent') !== -1) return 'excellent';
    if (status.indexOf('è½»å¾®') !== -1 || status.indexOf('good') !== -1) return 'good';
    if (status.indexOf('ä¸­åº¦') !== -1 || status.indexOf('moderate') !== -1) return 'warning';
    if (status.indexOf('ä¸¥é‡') !== -1 || status.indexOf('poor') !== -1) return 'poor';
    return 'good';
  }
  
  /**
   * è·å–å¥åº·å›¾æ ‡
   * @param {string} healthStatus - å¥åº·çŠ¶æ€
   * @returns {string} å¥åº·å›¾æ ‡
   */
  function getHealthIcon(healthStatus) {
    if (!healthStatus) return 'â“';
    
    var status = healthStatus.toLowerCase();
    if (status.indexOf('å®Œå…¨å¥åº·') !== -1 || status.indexOf('excellent') !== -1) return 'ğŸ’š';
    if (status.indexOf('è½»å¾®') !== -1 || status.indexOf('good') !== -1) return 'ğŸ’›';
    if (status.indexOf('ä¸­åº¦') !== -1 || status.indexOf('moderate') !== -1) return 'ğŸ§¡';
    if (status.indexOf('ä¸¥é‡') !== -1 || status.indexOf('poor') !== -1) return 'â¤ï¸';
    return 'ğŸ’š';
  }
  
  /**
   * è·å–å“è´¨ç­‰çº§
   * @param {number} qualityScore - å“è´¨åˆ†æ•°
   * @returns {string} å“è´¨ç­‰çº§
   */
  function getQualityGrade(qualityScore) {
    if (!qualityScore) return 'æœªè¯„çº§';
    
    if (qualityScore >= 90) return 'ä¼˜è´¨';
    if (qualityScore >= 80) return 'è‰¯å¥½';
    if (qualityScore >= 70) return 'ä¸€èˆ¬';
    if (qualityScore >= 60) return 'åˆæ ¼';
    return 'ä¸åˆæ ¼';
  }
  
  /**
   * è·å–æ˜Ÿçº§æ•°é‡
   * @param {number} qualityScore - å“è´¨åˆ†æ•°
   * @returns {number} æ˜Ÿçº§æ•°é‡
   */
  function getStarCount(qualityScore) {
    if (!qualityScore) return 0;
    return Math.round(qualityScore / 20);
  }
  
  /**
   * è·å–æ“ä½œå»ºè®®æ–‡æœ¬
   * @param {string} actionCode - æ“ä½œä»£ç 
   * @returns {string} æ“ä½œæ–‡æœ¬
   */
  function getActionText(actionCode) {
    var actionMap = {
      'harvest_now': 'ç«‹å³é‡‡æ‘˜',
      'harvest_priority': 'ä¼˜å…ˆé‡‡æ‘˜',
      'harvest_normal': 'æ­£å¸¸é‡‡æ‘˜',
      'wait_3_days': 'ç­‰å¾…3å¤©',
      'wait_week': 'ç­‰å¾…ä¸€å‘¨',
      'inspect_closely': 'å¯†åˆ‡è§‚å¯Ÿ',
      'reject': 'ä¸å»ºè®®é‡‡æ‘˜'
    };
    
    return actionMap[actionCode] || actionCode || 'æœªçŸ¥æ“ä½œ';
  }
  
  /**
   * è®¡ç®—å•æœä»·å€¼
   * @param {number} marketValue - å¸‚åœºä»·æ ¼(å…ƒ/æ–¤)
   * @param {number} estimatedWeight - é¢„ä¼°é‡é‡(å…‹)
   * @returns {string} å•æœä»·å€¼
   */
  function calculateFruitValue(marketValue, estimatedWeight) {
    if (!marketValue || !estimatedWeight) return '0.00';
    
    // è½¬æ¢ä¸ºå…ƒ/å…‹ï¼Œç„¶åè®¡ç®—å•æœä»·å€¼
    var pricePerGram = marketValue / 500; // 1æ–¤ = 500å…‹
    var fruitValue = pricePerGram * estimatedWeight;
    
    return fruitValue.toFixed(2);
  }
  
  /**
   * å®‰å…¨åœ°å¤„ç†æ“ä½œçŠ¶æ€ï¼Œç§»é™¤ç©ºæ ¼å¹¶è½¬ä¸ºå°å†™ï¼ˆä¿®å¤WXMLç¼–è¯‘é”™è¯¯ï¼‰
   * @param {string} actionTaken - æ“ä½œçŠ¶æ€
   * @returns {string} å¤„ç†åçš„CSSç±»å
   */
  function getActionStatusClass(actionTaken) {
    if (!actionTaken) return 'default';
    
    var result = actionTaken + '';
    // æ‰‹åŠ¨ç§»é™¤ç©ºæ ¼ï¼ˆæ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼ï¼‰
    var cleaned = '';
    for (var i = 0; i < result.length; i++) {
      var char = result.charAt(i);
      if (char !== ' ' && char !== '\t' && char !== '\n' && char !== '\r') {
        cleaned += char;
      }
    }
    
    // è½¬ä¸ºå°å†™
    cleaned = cleaned.toLowerCase();
    
    return cleaned || 'default';
  }
  
  module.exports = {
    getMaturityStage: getMaturityStage,
    getRipenessText: getRipenessText,
    getMaturityRecommendation: getMaturityRecommendation,
    getHealthLevel: getHealthLevel,
    getHealthIcon: getHealthIcon,
    getQualityGrade: getQualityGrade,
    getStarCount: getStarCount,
    getActionText: getActionText,
    calculateFruitValue: calculateFruitValue,
    getActionStatusClass: getActionStatusClass
  };