<!--pages/detection/detection.wxml-->
<!--æ™ºèƒ½æ°´æœè¯†åˆ«é¡µé¢ - ç‹¬ç«‹æ ‡ç­¾é¡µè®¾è®¡-->

<!-- å¼•å…¥å·¥å…·æ–¹æ³• -->
<wxs module="utils" src="./utils.wxs"></wxs>

<view class="detection-container">
  
  <!-- é¡µé¢å¤´éƒ¨çŠ¶æ€æ  -->
  <view class="header-status">
    <view class="status-item">
      <view class="status-dot {{aiServiceStatus === 'online' ? 'online' : 'offline'}}"></view>
      <text class="status-text">AIæœåŠ¡{{aiServiceStatus === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
    </view>
    <view class="status-item">
      <text class="today-count">ä»Šæ—¥æ£€æµ‹ï¼š{{todayDetectionCount}}æ¬¡</text>
    </view>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <scroll-view class="main-content" scroll-y="true" enhanced="true" show-scrollbar="false">
    
    <!-- æ‹æ‘„è¯†åˆ«å¡ç‰‡ -->
    <view class="detection-card">
      <view class="card-header">
        <view class="header-left">
          <text class="card-icon">ğŸ“¸</text>
          <text class="card-title">æ™ºèƒ½æ£€æµ‹</text>
        </view>
        <view class="header-right">
          <text class="detection-mode {{detectionMode}}">{{detectionModeText}}</text>
        </view>
      </view>

      <!-- å›¾ç‰‡é€‰æ‹©åŒºåŸŸ -->
      <view class="image-selection-area">
        <!-- å¦‚æœæ²¡æœ‰é€‰æ‹©å›¾ç‰‡ï¼Œæ˜¾ç¤ºé€‰æ‹©åŒºåŸŸ -->
        <view class="image-placeholder" wx:if="{{!currentImage}}" bindtap="showImageOptions">
          <view class="placeholder-content">
            <view class="placeholder-icon">ğŸ“·</view>
            <text class="placeholder-title">é€‰æ‹©æ°´æœå›¾ç‰‡è¿›è¡Œæ£€æµ‹</text>
            <text class="placeholder-subtitle">æ”¯æŒæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©</text>
          </view>
          <view class="selection-buttons">
            <view class="selection-btn camera-btn" catchtap="showImageOptions">
              <text class="btn-icon">ğŸ“·</text>
              <text class="btn-text">æ‹ç…§æ£€æµ‹</text>
            </view>
            <view class="selection-btn album-btn" catchtap="showImageOptions">
              <text class="btn-icon">ğŸ–¼ï¸</text>
              <text class="btn-text">ç›¸å†Œé€‰æ‹©</text>
            </view>
          </view>
        </view>

        <!-- å·²é€‰æ‹©å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
        <view class="selected-image-area" wx:if="{{currentImage}}">
          <image src="{{currentImage}}" class="selected-image" mode="aspectFill" bindtap="previewImage"></image>
          
          <!-- å›¾ç‰‡ä¿¡æ¯è¦†ç›–å±‚ -->
          <view class="image-overlay">
            <view class="image-info">
              <text class="image-name">{{imageName}}</text>
              <text class="image-time">{{imageTime}}</text>
            </view>
            <view class="image-actions">
              <view class="action-btn reselect-btn" bindtap="showImageOptions">
                <text class="action-icon">ğŸ”„</text>
              </view>
              <view class="action-btn delete-btn" bindtap="clearCurrentImage">
                <text class="action-icon">ğŸ—‘ï¸</text>
              </view>
            </view>
          </view>

          <!-- AIè¯†åˆ«åŒºåŸŸæ ‡è®° (å¦‚æœæœ‰è¯†åˆ«ç»“æœ) -->
          <view class="detection-overlay" wx:if="{{detectionResult && detectionResult.boundingBox}}">
            <view class="detection-box" style="left: {{detectionResult.boundingBox.x}}px; top: {{detectionResult.boundingBox.y}}px; width: {{detectionResult.boundingBox.width}}px; height: {{detectionResult.boundingBox.height}}px;">
              <text class="detection-label">{{detectionResult.fruitType}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ£€æµ‹æ§åˆ¶æŒ‰é’® - ä¿®å¤ç‰ˆæœ¬ -->
      <view class="detection-controls">
        <button class="detect-btn {{!currentImage || detecting ? 'disabled' : 'active'}}" 
                bindtap="startDetection" 
                disabled="{{!currentImage || detecting}}">
          
          <!-- éæ£€æµ‹çŠ¶æ€æ–‡å­— - ä¿®å¤å±…ä¸­ -->
          <view class="detect-text" wx:if="{{!detecting}}">
            {{currentImage ? 'AIæ™ºèƒ½åˆ†æ' : 'è¯·é€‰æ‹©å›¾ç‰‡'}}
          </view>
          
          <!-- æ£€æµ‹ä¸­åŠ¨ç”» - ä¿®å¤å±…ä¸­ -->
          <view class="detecting-animation" wx:if="{{detecting}}">
            <view class="loading-dot"></view>
            <view class="loading-dot"></view>
            <view class="loading-dot"></view>
            <text class="detecting-text">AIåˆ†æä¸­...</text>
          </view>
        </button>
        
        <!-- å¿«é€Ÿè®¾ç½® -->
        <view class="quick-settings">
          <view class="setting-item" bindtap="toggleDetectionMode">
            <text class="setting-label">æ£€æµ‹æ¨¡å¼</text>
            <text class="setting-value">{{detectionModeText}}</text>
            <text class="setting-arrow">â€º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆ†æç»“æœå¡ç‰‡ -->
    <view class="result-card" wx:if="{{detectionResult}}">
      <view class="result-header">
        <text class="result-icon">ğŸ”</text>
        <text class="result-title">AIåˆ†æç»“æœ</text>
        <view class="confidence-badge">
          <text class="confidence-text">ç½®ä¿¡åº¦ {{detectionResult.confidence}}%</text>
        </view>
      </view>

      <view class="result-content">
        <!-- æ°´æœåŸºæœ¬ä¿¡æ¯ -->
        <view class="fruit-basic-info">
          <view class="fruit-avatar">
            <text class="fruit-emoji">{{detectionResult.fruitEmoji}}</text>
          </view>
          <view class="fruit-details">
            <text class="fruit-name">{{detectionResult.fruitType}}</text>
            <text class="fruit-variety">{{detectionResult.variety}}</text>
          </view>
          <view class="overall-grade {{utils.safeToLowerCase(detectionResult.overallGrade)}}">
            <text class="grade-text">{{detectionResult.overallGrade}}</text>
          </view>
        </view>

        <!-- è¯¦ç»†åˆ†ææŒ‡æ ‡ -->
        <view class="analysis-metrics">
          <view class="metric-item">
            <view class="metric-header">
              <text class="metric-label">æˆç†Ÿåº¦</text>
              <text class="metric-value">{{detectionResult.maturity}}%</text>
            </view>
            <progress class="metric-progress" 
                     percent="{{detectionResult.maturity}}" 
                     activeColor="{{detectionResult.maturity >= 80 ? '#4CAF50' : detectionResult.maturity >= 60 ? '#FF9800' : '#F44336'}}"
                     backgroundColor="#E0E0E0" 
                     stroke-width="6" />
          </view>

          <view class="metric-item">
            <view class="metric-header">
              <text class="metric-label">å¥åº·çŠ¶å†µ</text>
              <text class="metric-value {{utils.safeToLowerCase(detectionResult.healthGrade)}}">{{detectionResult.healthStatus}}</text>
            </view>
            <view class="health-indicators">
              <view class="health-tag {{detectionResult.pestStatus === 'none' ? 'good' : 'warning'}}">
                <text class="tag-text">ç—…è™«å®³: {{detectionResult.pestStatus === 'none' ? 'æ— ' : detectionResult.pestStatus}}</text>
              </view>
              <view class="health-tag {{detectionResult.diseaseStatus === 'none' ? 'good' : 'warning'}}">
                <text class="tag-text">ç—…å®³: {{detectionResult.diseaseStatus === 'none' ? 'æ— ' : detectionResult.diseaseStatus}}</text>
              </view>
            </view>
          </view>

          <view class="metric-item">
            <view class="metric-header">
              <text class="metric-label">å“è´¨è¯„ä¼°</text>
              <text class="metric-value">{{detectionResult.qualityScore}}/100</text>
            </view>
            <view class="quality-breakdown">
              <view class="quality-item">
                <text class="quality-aspect">å¤–è§‚</text>
                <view class="quality-stars">
                  <text class="star {{index < detectionResult.appearanceStars ? 'filled' : 'empty'}}" 
                        wx:for="{{[1,2,3,4,5]}}" wx:key="index">â˜…</text>
                </view>
              </view>
              <view class="quality-item">
                <text class="quality-aspect">å¤§å°</text>
                <text class="quality-text">{{detectionResult.sizeCategory}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- AIå»ºè®® -->
        <view class="ai-recommendation">
          <view class="recommendation-header">
            <text class="recommendation-icon">ğŸ’¡</text>
            <text class="recommendation-title">AIå»ºè®®</text>
          </view>
          <text class="recommendation-text">{{detectionResult.recommendation}}</text>
          
          <!-- è¡ŒåŠ¨å»ºè®®æŒ‰é’® -->
          <view class="action-suggestions" wx:if="{{detectionResult.actionable}}">
            <button class="suggestion-btn harvest" 
                    wx:if="{{detectionResult.suggestedAction === 'harvest'}}"
                    bindtap="executeSuggestedAction">
              ç«‹å³é‡‡æ‘˜
            </button>
            <button class="suggestion-btn wait" 
                    wx:if="{{detectionResult.suggestedAction === 'wait'}}"
                    bindtap="setReminder">
              è®¾ç½®æé†’
            </button>
            <button class="suggestion-btn inspect" 
                    wx:if="{{detectionResult.suggestedAction === 'inspect'}}"
                    bindtap="markForInspection">
              æ ‡è®°æ£€æŸ¥
            </button>
          </view>
        </view>
      </view>

      <!-- ç»“æœæ“ä½œåŒºåŸŸ -->
      <view class="result-actions">
        <button class="result-action-btn share" bindtap="shareResult">
          <text class="action-btn-icon">ğŸ“¤</text>
          <text class="action-btn-text">åˆ†äº«</text>
        </button>
        <button class="result-action-btn save" bindtap="saveResult">
          <text class="action-btn-icon">ğŸ’¾</text>
          <text class="action-btn-text">ä¿å­˜</text>
        </button>
        <button class="result-action-btn report" bindtap="generateReport">
          <text class="action-btn-icon">ğŸ“Š</text>
          <text class="action-btn-text">æŠ¥å‘Š</text>
        </button>
      </view>
    </view>

    <!-- å†å²è®°å½•å¡ç‰‡ -->
    <view class="history-card">
      <view class="history-header">
        <view class="header-left">
          <text class="history-icon">ğŸ“‹</text>
          <text class="history-title">æ£€æµ‹å†å²</text>
        </view>
        <view class="header-right">
          <view class="clear-data-btn" bindtap="clearLocalDetectionData">
            <text class="clear-icon">ğŸ—‘ï¸</text>
          </view>
          <picker bindchange="onDateFilterChange" mode="date" value="{{filterDate}}">
            <view class="date-filter">
              <text class="filter-text">{{filterDateText}}</text>
              <text class="filter-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- å†å²ç»Ÿè®¡æ¦‚è§ˆ -->
      <view class="history-stats">
        <view class="stat-item">
          <text class="stat-number">{{historyStats.totalDetections}}</text>
          <text class="stat-label">æ€»æ£€æµ‹</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{historyStats.excellentCount}}</text>
          <text class="stat-label">ä¼˜è´¨æœ</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{historyStats.averageMaturity}}</text>
          <text class="stat-label">å¹³å‡æˆç†Ÿåº¦</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{historyStats.accuracyRate}}%</text>
          <text class="stat-label">å‡†ç¡®ç‡</text>
        </view>
      </view>

      <!-- æ£€æµ‹è®°å½•åˆ—è¡¨ -->
      <view class="detection-list">
        <!-- åˆ—è¡¨ä¸ºç©ºæ—¶çš„æç¤º -->
        <view class="empty-list" wx:if="{{detectionHistory.length === 0}}">
          <view class="empty-icon">ğŸ“­</view>
          <text class="empty-title">æš‚æ— æ£€æµ‹è®°å½•</text>
          <text class="empty-subtitle">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡æ™ºèƒ½æ£€æµ‹å§</text>
        </view>

        <!-- æ£€æµ‹è®°å½•é¡¹ -->
        <view class="detection-item" 
              wx:for="{{detectionHistory}}" 
              wx:key="id" 
              bindtap="viewDetectionDetail" 
              data-id="{{item.id}}">
          
          <view class="item-image">
            <!-- æ˜¾ç¤ºæœ¬åœ°å›¾ç‰‡æˆ–å ä½ç¬¦ -->
            <image wx:if="{{item.imageUrl}}" 
                   class="fruit-thumbnail" 
                   src="{{item.imageUrl}}" 
                   mode="aspectFill"
                   lazy-load="true"
                   binderror="onImageError"
                   data-id="{{item.id}}">
            </image>
            <view wx:else class="thumbnail-placeholder">{{utils.getFirstChar(item.fruitType)}}</view>
            
            <!-- æœ¬åœ°å›¾ç‰‡æ ‡è¯† -->
            <view wx:if="{{item.isLocalImage}}" class="local-image-badge">
              <text class="local-badge-text">æœ¬åœ°</text>
            </view>
            
            <view class="detection-badge {{utils.safeToLowerCase(item.grade)}}">
              <text class="badge-text">{{item.grade}}</text>
            </view>
          </view>

          <view class="item-content">
            <view class="item-header">
              <text class="fruit-type">{{item.fruitType}}</text>
              <text class="detection-time">{{item.detectionTime}}</text>
            </view>
            
            <view class="item-metrics">
              <view class="metric-tag maturity">
                <text class="tag-label">æˆç†Ÿåº¦</text>
                <text class="tag-value">{{item.maturity}}%</text>
              </view>
              <view class="metric-tag health">
                <text class="tag-label">å¥åº·</text>
                <text class="tag-value">{{item.healthStatus}}</text>
              </view>
              <view class="metric-tag quality">
                <text class="tag-label">å“è´¨</text>
                <text class="tag-value">{{item.qualityScore}}</text>
              </view>
            </view>

            <view class="item-footer">
              <text class="item-location">{{item.location}}</text>
              <view class="item-status {{utils.safeToLowerCase(item.actionTaken)}}">
                <text class="status-text">{{item.actionTaken}}</text>
              </view>
            </view>
          </view>

          <view class="item-actions">
            <view class="quick-action" bindtap="quickAction" data-action="reanalyze" data-id="{{item.id}}">
              <text class="action-icon">ğŸ”„</text>
            </view>
            <view class="quick-action" bindtap="quickAction" data-action="share" data-id="{{item.id}}">
              <text class="action-icon">ğŸ“¤</text>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view class="load-more" wx:if="{{hasMoreHistory}}" bindtap="loadMoreHistory">
          <text class="load-more-text">{{loadingMoreHistory ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨é—´è· -->
    <view class="bottom-spacing"></view>
  </scroll-view>

  <!-- å›¾ç‰‡é€‰æ‹©æ“ä½œè¡¨ -->
  <view class="image-options-modal {{showImageOptions ? 'show' : 'hide'}}" bindtap="hideImageOptions">
    <view class="options-content" catchtap="stopPropagation">
      <view class="options-header">
        <text class="options-title">é€‰æ‹©å›¾ç‰‡</text>
        <view class="close-btn" bindtap="hideImageOptions">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="options-list">
        <view class="option-item" bindtap="takePhoto">
          <view class="option-icon camera">ğŸ“·</view>
          <view class="option-content">
            <text class="option-title">æ‹æ‘„ç…§ç‰‡</text>
            <text class="option-desc">ä½¿ç”¨ç›¸æœºæ‹æ‘„æ°´æœç…§ç‰‡</text>
          </view>
        </view>
        
        <view class="option-item" bindtap="chooseFromAlbum">
          <view class="option-icon album">ğŸ–¼ï¸</view>
          <view class="option-content">
            <text class="option-title">ä»ç›¸å†Œé€‰æ‹©</text>
            <text class="option-desc">ä»æ‰‹æœºç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡</text>
          </view>
        </view>
        
        <view class="option-item" bindtap="chooseMultipleImages">
          <view class="option-icon multiple">ğŸ“</view>
          <view class="option-content">
            <text class="option-title">æ‰¹é‡é€‰æ‹©</text>
            <text class="option-desc">ä¸€æ¬¡é€‰æ‹©å¤šå¼ å›¾ç‰‡è¿›è¡Œæ£€æµ‹</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ£€æµ‹æ¨¡å¼é€‰æ‹©æ¨¡æ€æ¡† -->
  <view class="mode-modal {{showModeModal ? 'show' : 'hide'}}" bindtap="hideModeModal">
    <view class="mode-content" catchtap="stopPropagation">
      <view class="mode-header">
        <text class="mode-title">æ£€æµ‹æ¨¡å¼</text>
        <view class="close-btn" bindtap="hideModeModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="mode-list">
        <view class="mode-item {{detectionMode === 'comprehensive' ? 'selected' : ''}}" 
              bindtap="selectDetectionMode" data-mode="comprehensive">
          <view class="mode-info">
            <text class="mode-name">ç»¼åˆæ£€æµ‹</text>
            <text class="mode-desc">å…¨é¢åˆ†ææˆç†Ÿåº¦ã€ç—…è™«å®³ã€å“è´¨ç­‰</text>
          </view>
          <view class="mode-indicator">
            <text class="indicator-icon">{{detectionMode === 'comprehensive' ? 'âœ“' : ''}}</text>
          </view>
        </view>
        
        <view class="mode-item {{detectionMode === 'maturity' ? 'selected' : ''}}" 
              bindtap="selectDetectionMode" data-mode="maturity">
          <view class="mode-info">
            <text class="mode-name">æˆç†Ÿåº¦æ£€æµ‹</text>
            <text class="mode-desc">ä¸“æ³¨äºæ°´æœæˆç†Ÿåº¦è¯„ä¼°</text>
          </view>
          <view class="mode-indicator">
            <text class="indicator-icon">{{detectionMode === 'maturity' ? 'âœ“' : ''}}</text>
          </view>
        </view>
        
        <view class="mode-item {{detectionMode === 'health' ? 'selected' : ''}}" 
              bindtap="selectDetectionMode" data-mode="health">
          <view class="mode-info">
            <text class="mode-name">å¥åº·æ£€æµ‹</text>
            <text class="mode-desc">é‡ç‚¹æ£€æµ‹ç—…è™«å®³å’Œç–¾ç—…</text>
          </view>
          <view class="mode-indicator">
            <text class="indicator-icon">{{detectionMode === 'health' ? 'âœ“' : ''}}</text>
          </view>
        </view>
        
        <view class="mode-item {{detectionMode === 'quality' ? 'selected' : ''}}" 
              bindtap="selectDetectionMode" data-mode="quality">
          <view class="mode-info">
            <text class="mode-name">å“è´¨è¯„ä¼°</text>
            <text class="mode-desc">è¯„ä¼°æ°´æœå¤–è§‚å’Œå¸‚åœºå“è´¨</text>
          </view>
          <view class="mode-indicator">
            <text class="indicator-icon">{{detectionMode === 'quality' ? 'âœ“' : ''}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- éšè—çš„Canvasç”¨äºå›¾åƒå¤„ç† - ä½¿ç”¨Canvas 2D -->
  <canvas type="2d" id="imageProcessCanvas" class="hidden-canvas"></canvas>
</view>