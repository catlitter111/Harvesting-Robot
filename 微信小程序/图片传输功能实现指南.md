# å›¾ç‰‡ä¼ è¾“åŠŸèƒ½å®ç°æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°
å®ç°å°†ROS2èŠ‚ç‚¹è¯†åˆ«çš„çœŸå®æ°´æœå›¾ç‰‡ä¼ è¾“åˆ°å¾®ä¿¡å°ç¨‹åºï¼Œæ›¿æ¢åŸæœ‰çš„æ–‡å­—å ä½ç¬¦ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°å®é™…çš„è¯†åˆ«å›¾ç‰‡ã€‚

## å®ç°æ¶æ„

### æ•°æ®æµç¨‹
```
ROS2èŠ‚ç‚¹ â†’ Base64ç¼–ç å›¾ç‰‡ â†’ WebSocketå‘é€ â†’ æœåŠ¡å™¨æ¥æ”¶ â†’ ä¿å­˜å›¾ç‰‡æ–‡ä»¶ â†’ ç”ŸæˆURL â†’ è½¬å‘ç»™å¾®ä¿¡å°ç¨‹åº â†’ æ˜¾ç¤ºçœŸå®å›¾ç‰‡
```

### æŠ€æœ¯è¦ç‚¹
1. **å›¾ç‰‡ç¼–ç **: ROS2èŠ‚ç‚¹å°†å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºBase64æ ¼å¼
2. **å›¾ç‰‡å­˜å‚¨**: æœåŠ¡å™¨å°†Base64æ•°æ®è§£ç å¹¶ä¿å­˜ä¸ºæ–‡ä»¶
3. **é™æ€æœåŠ¡**: æœåŠ¡å™¨æä¾›å›¾ç‰‡çš„HTTPè®¿é—®æœåŠ¡
4. **åŠ¨æ€æ˜¾ç¤º**: å¾®ä¿¡å°ç¨‹åºæ ¹æ®å›¾ç‰‡URLåŠ¨æ€åŠ è½½æ˜¾ç¤º

## ä¿®æ”¹å†…å®¹è¯¦è§£

### 1. ROS2èŠ‚ç‚¹ä¿®æ”¹ (`websocket_bridge_node.py`)

#### æ·»åŠ å›¾ç‰‡æ•°æ®åˆ°æ¶ˆæ¯
```python
# åœ¨ process_fruit_recognition å‡½æ•°ä¸­
detection_data = {
    # ... å…¶ä»–å­—æ®µ ...
    'source_image': filename,
    'image_base64': image_base64,  # æ·»åŠ base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
    'image_data_url': data_url     # æ·»åŠ å®Œæ•´çš„data URL
}
```

**ä½œç”¨**: å°†åŸå§‹å›¾ç‰‡æ•°æ®åŒ…å«åœ¨è¯†åˆ«ç»“æœä¸­ï¼Œä¾¿äºæœåŠ¡å™¨ä¿å­˜å’Œå¤„ç†ã€‚

### 2. æœåŠ¡å™¨ç«¯ä¿®æ”¹ (`server.py`)

#### æ·»åŠ å¿…è¦çš„å¯¼å…¥
```python
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
import base64
import os
from pathlib import Path
```

#### åˆ›å»ºå›¾ç‰‡å­˜å‚¨ç›®å½•å’Œé™æ€æœåŠ¡
```python
# åˆ›å»ºå›¾ç‰‡å­˜å‚¨ç›®å½•
IMAGES_DIR = Path("fruit_images")
IMAGES_DIR.mkdir(exist_ok=True)

# æŒ‚è½½é™æ€æ–‡ä»¶æœåŠ¡
app.mount("/images", StaticFiles(directory=str(IMAGES_DIR)), name="images")
```

#### å›¾ç‰‡å¤„ç†é€»è¾‘
```python
# åœ¨ handle_fruit_detection_result å‡½æ•°ä¸­
if "image_base64" in detection_data and detection_data["image_base64"]:
    # ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°
    image_filename = f"fruit_{robot_id}_{timestamp}.jpg"
    image_path = IMAGES_DIR / image_filename
    
    # è§£ç base64å›¾ç‰‡æ•°æ®
    image_data = base64.b64decode(detection_data["image_base64"])
    
    # ä¿å­˜å›¾ç‰‡æ–‡ä»¶
    with open(image_path, "wb") as f:
        f.write(image_data)
    
    # ç”Ÿæˆå¯è®¿é—®çš„URL
    image_url = f"/images/{image_filename}"
    
    # æ›´æ–°detection_dataä¸­çš„å›¾ç‰‡URL
    detection_data["imageUrl"] = image_url
```

**ä½œç”¨**: 
- æ¥æ”¶Base64ç¼–ç çš„å›¾ç‰‡æ•°æ®
- è§£ç å¹¶ä¿å­˜ä¸ºå®é™…å›¾ç‰‡æ–‡ä»¶
- ç”ŸæˆHTTPå¯è®¿é—®çš„URL
- é€šè¿‡é™æ€æ–‡ä»¶æœåŠ¡æä¾›å›¾ç‰‡è®¿é—®

### 3. å¾®ä¿¡å°ç¨‹åºä¿®æ”¹

#### æ•°æ®æ ¼å¼åŒ– (`detection.js`)
```javascript
// åœ¨ formatServerDetectionResult å‡½æ•°ä¸­
return {
    // ... å…¶ä»–å­—æ®µ ...
    thumbnailUrl: data.imageUrl || data.thumbnailUrl || '',
    imagePath: data.imageUrl || data.imagePath || '',
    imageUrl: data.imageUrl || data.thumbnailUrl || '',  // æ·»åŠ imageUrlå­—æ®µ
    // ... å…¶ä»–å­—æ®µ ...
};
```

#### é¡µé¢æ•°æ®é…ç½®
```javascript
data: {
    // ... å…¶ä»–å­—æ®µ ...
    serverBaseUrl: 'http://localhost:8000'  // æœåŠ¡å™¨åŸºç¡€URL
}
```

#### å›¾ç‰‡é”™è¯¯å¤„ç†
```javascript
onImageError: function(e) {
    const itemId = e.currentTarget.dataset.id;
    console.log(`å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè®°å½•ID: ${itemId}`);
    
    wx.showToast({
        title: 'å›¾ç‰‡åŠ è½½å¤±è´¥',
        icon: 'none',
        duration: 1000
    });
}
```

#### ç•Œé¢æ˜¾ç¤º (`detection.wxml`)
```xml
<view class="item-image">
    <!-- æ˜¾ç¤ºçœŸå®å›¾ç‰‡æˆ–å ä½ç¬¦ -->
    <image wx:if="{{item.imageUrl}}" 
           class="fruit-thumbnail" 
           src="{{serverBaseUrl}}{{item.imageUrl}}" 
           mode="aspectFill"
           lazy-load="true"
           binderror="onImageError"
           data-id="{{item.id}}">
    </image>
    <view wx:else class="thumbnail-placeholder">{{utils.getFirstChar(item.fruitType)}}</view>
    <!-- æ£€æµ‹ç­‰çº§å¾½ç«  -->
    <view class="detection-badge {{utils.safeToLowerCase(item.grade)}}">
        <text class="badge-text">{{item.grade}}</text>
    </view>
</view>
```

#### æ ·å¼å®šä¹‰ (`detection.wxss`)
```css
.fruit-thumbnail {
    width: 80rpx;
    height: 80rpx;
    border-radius: 12rpx;
    border: 2rpx solid #E0E0E0;
    background: #F5F5F5;
}
```

## éªŒè¯æ­¥éª¤

### æ­¥éª¤1: å¯åŠ¨ç³»ç»Ÿ
```bash
# 1. å¯åŠ¨ROS2æ°´æœè¯†åˆ«ç³»ç»Ÿ
cd Harvesting-Robot/robot_ROS2-6_9
source install/setup.bash
ros2 launch bottle_detection_ros2 fruit_detection_test.launch.py

# 2. å¯åŠ¨æœåŠ¡å™¨
cd ../ä¸Šä½æœºä¸æœåŠ¡ç«¯
python server.py

# 3. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ŒåŠ è½½å°ç¨‹åºé¡¹ç›®
```

### æ­¥éª¤2: æ¸…é™¤æ—§æ•°æ®
1. åœ¨å¾®ä¿¡å°ç¨‹åºæ£€æµ‹é¡µé¢ï¼Œç‚¹å‡»å³ä¸Šè§’åƒåœ¾æ¡¶å›¾æ ‡
2. ç¡®è®¤æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ£€æµ‹å†å²è®°å½•
3. åˆ é™¤æœåŠ¡å™¨ç«¯çš„å›¾ç‰‡å­˜å‚¨ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### æ­¥éª¤3: è§¦å‘æ°´æœè¯†åˆ«
1. å‘å¸ƒæ°´æœå›¾ç‰‡åˆ°ROS2è¯é¢˜
2. è§‚å¯ŸROS2èŠ‚ç‚¹æ—¥å¿—ï¼Œç¡®è®¤å›¾ç‰‡æ•°æ®åŒ…å«åœ¨æ¶ˆæ¯ä¸­
3. è§‚å¯ŸæœåŠ¡å™¨æ§åˆ¶å°ï¼Œç¡®è®¤å›¾ç‰‡ä¿å­˜æˆåŠŸ

### æ­¥éª¤4: éªŒè¯å›¾ç‰‡æ˜¾ç¤º
1. æ£€æŸ¥å¾®ä¿¡å°ç¨‹åºæ˜¯å¦æ”¶åˆ°è¯†åˆ«ç»“æœ
2. æŸ¥çœ‹æ£€æµ‹å†å²åˆ—è¡¨ï¼Œç¡®è®¤æ˜¾ç¤ºçœŸå®å›¾ç‰‡è€Œä¸æ˜¯å ä½ç¬¦
3. éªŒè¯å›¾ç‰‡åŠ è½½æ˜¯å¦æ­£å¸¸

## é¢„æœŸç»“æœ

### ROS2èŠ‚ç‚¹æ—¥å¿—
```
[websocket_bridge_node-2] [INFO] [1749897748.061232606] [websocket_bridge]: æ°´æœè¯†åˆ«å®Œæˆ: æ©™å­, è´¨é‡: 85/100, æˆç†Ÿåº¦: 90%
```

### æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡º
```
================================================================================
ğŸ æ°´æœè¯†åˆ«ç»“æœ - æœºå™¨äºº: robot_001
================================================================================
ğŸ“¸ æºå›¾ç‰‡: fruit_image_20250125_184248.jpg
ğŸ–¼ï¸  å›¾ç‰‡URL: /images/fruit_robot_001_1749897748061.jpg
ğŸ•’ æ£€æµ‹æ—¶é—´: 18:42
ğŸ“ æ£€æµ‹ä½ç½®: B-12åŒºåŸŸ
--------------------------------------------------------------------------------
ğŸ æ°´æœç±»å‹: æ©™å­
ğŸŒ± æˆç†Ÿåº¦: 90%
â­ å“è´¨åˆ†æ•°: 85/100
ğŸ¥ å¥åº·çŠ¶æ€: å¥åº·
ğŸ¯ è¯†åˆ«ç½®ä¿¡åº¦: 95%
================================================================================
```

### æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ
```
ä¸Šä½æœºä¸æœåŠ¡ç«¯/
â”œâ”€â”€ server.py
â”œâ”€â”€ fruit_images/           # æ–°åˆ›å»ºçš„å›¾ç‰‡å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ fruit_robot_001_1749897748061.jpg
â”‚   â”œâ”€â”€ fruit_robot_001_1749897750123.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

### å¾®ä¿¡å°ç¨‹åºæ˜¾ç¤º
- **å†å²è®°å½•åˆ—è¡¨**: æ˜¾ç¤ºçœŸå®çš„æ°´æœå›¾ç‰‡ç¼©ç•¥å›¾
- **å›¾ç‰‡åŠ è½½**: æ”¯æŒæ‡’åŠ è½½å’Œé”™è¯¯å¤„ç†
- **å ä½ç¬¦**: å½“å›¾ç‰‡ä¸å¯ç”¨æ—¶æ˜¾ç¤ºæ–‡å­—å ä½ç¬¦

### HTTPè®¿é—®éªŒè¯
å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®å›¾ç‰‡ï¼š
```
http://localhost:8000/images/fruit_robot_001_1749897748061.jpg
```

## æ•…éšœæ’é™¤

### å›¾ç‰‡ä¸æ˜¾ç¤ºçš„å¯èƒ½åŸå› 
1. **æœåŠ¡å™¨URLé…ç½®é”™è¯¯**: æ£€æŸ¥`serverBaseUrl`æ˜¯å¦æ­£ç¡®
2. **å›¾ç‰‡ä¿å­˜å¤±è´¥**: æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. **Base64æ•°æ®æŸå**: æ£€æŸ¥ROS2èŠ‚ç‚¹çš„å›¾ç‰‡ç¼–ç è¿‡ç¨‹
4. **ç½‘ç»œè¿æ¥é—®é¢˜**: ç¡®è®¤å¾®ä¿¡å°ç¨‹åºèƒ½è®¿é—®æœåŠ¡å™¨

### å›¾ç‰‡åŠ è½½ç¼“æ…¢
1. **å›¾ç‰‡å°ºå¯¸è¿‡å¤§**: è€ƒè™‘åœ¨ROS2èŠ‚ç‚¹ä¸­å‹ç¼©å›¾ç‰‡
2. **ç½‘ç»œå¸¦å®½é™åˆ¶**: ä¼˜åŒ–å›¾ç‰‡è´¨é‡å’Œå°ºå¯¸
3. **æœåŠ¡å™¨æ€§èƒ½**: æ£€æŸ¥æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ

### å­˜å‚¨ç©ºé—´ç®¡ç†
1. **å®šæœŸæ¸…ç†**: å®ç°å›¾ç‰‡æ–‡ä»¶çš„å®šæœŸæ¸…ç†æœºåˆ¶
2. **å­˜å‚¨é™åˆ¶**: è®¾ç½®æœ€å¤§å­˜å‚¨æ•°é‡æˆ–æ—¶é—´é™åˆ¶
3. **å‹ç¼©ä¼˜åŒ–**: ä½¿ç”¨é€‚å½“çš„å›¾ç‰‡å‹ç¼©ç®—æ³•

## æŠ€æœ¯ä¼˜åŠ¿

### 1. å®æ—¶æ€§
- å›¾ç‰‡éšè¯†åˆ«ç»“æœå®æ—¶ä¼ è¾“
- æ— éœ€é¢å¤–çš„å›¾ç‰‡ä¸Šä¼ æ­¥éª¤

### 2. å¯é æ€§
- Base64ç¼–ç ç¡®ä¿æ•°æ®å®Œæ•´æ€§
- é”™è¯¯å¤„ç†æœºåˆ¶ä¿è¯ç”¨æˆ·ä½“éªŒ

### 3. æ‰©å±•æ€§
- æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼
- å¯æ‰©å±•ä¸ºè§†é¢‘æµä¼ è¾“

### 4. ç”¨æˆ·ä½“éªŒ
- çœŸå®å›¾ç‰‡æä¾›ç›´è§‚çš„è¯†åˆ«åé¦ˆ
- æ‡’åŠ è½½ä¼˜åŒ–æ€§èƒ½

## åç»­ä¼˜åŒ–å»ºè®®

### 1. å›¾ç‰‡å‹ç¼©
åœ¨ROS2èŠ‚ç‚¹ä¸­æ·»åŠ å›¾ç‰‡å‹ç¼©ï¼š
```python
from PIL import Image
import io

# å‹ç¼©å›¾ç‰‡
img = Image.open(io.BytesIO(image_data))
img = img.resize((200, 200), Image.Resampling.LANCZOS)
compressed_buffer = io.BytesIO()
img.save(compressed_buffer, format='JPEG', quality=80)
compressed_data = compressed_buffer.getvalue()
```

### 2. ç¼“å­˜æœºåˆ¶
å®ç°å›¾ç‰‡ç¼“å­˜ä»¥æé«˜åŠ è½½é€Ÿåº¦ï¼š
```javascript
// åœ¨å¾®ä¿¡å°ç¨‹åºä¸­
wx.downloadFile({
    url: imageUrl,
    success: (res) => {
        // ç¼“å­˜åˆ°æœ¬åœ°
        wx.saveFile({
            tempFilePath: res.tempFilePath,
            success: (saveRes) => {
                // ä½¿ç”¨æœ¬åœ°è·¯å¾„
            }
        });
    }
});
```

### 3. æ‰¹é‡å¤„ç†
æ”¯æŒæ‰¹é‡å›¾ç‰‡è¯†åˆ«å’Œä¼ è¾“ã€‚

### 4. å›¾ç‰‡æ ‡æ³¨
åœ¨å›¾ç‰‡ä¸Šæ·»åŠ è¯†åˆ«ç»“æœçš„å¯è§†åŒ–æ ‡æ³¨ã€‚

é€šè¿‡ä»¥ä¸Šå®ç°ï¼Œç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨å¾®ä¿¡å°ç¨‹åºä¸­çœ‹åˆ°çœŸå®çš„æ°´æœè¯†åˆ«å›¾ç‰‡ï¼Œå¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿçš„å®ç”¨æ€§ã€‚ 