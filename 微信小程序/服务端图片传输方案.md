# æœåŠ¡ç«¯å›¾ç‰‡ä¼ è¾“æ–¹æ¡ˆ

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°
æœåŠ¡ç«¯ä¸å†ä¿å­˜å›¾ç‰‡æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥å°†å›¾ç‰‡çš„base64æ•°æ®ä¼ è¾“ç»™å¾®ä¿¡å°ç¨‹åºï¼Œç”±å°ç¨‹åºè´Ÿè´£æœ¬åœ°ä¿å­˜å’Œæ˜¾ç¤ºã€‚

## ğŸ”„ æ•°æ®æµç¨‹

```mermaid
graph TD
    A[æœºå™¨äººå‘é€è¯†åˆ«ç»“æœ] --> B[æœåŠ¡ç«¯æ¥æ”¶base64å›¾ç‰‡æ•°æ®]
    B --> C[æœåŠ¡ç«¯å¤„ç†è¯†åˆ«æ•°æ®]
    C --> D[é€šè¿‡WebSocketå‘é€ç»™å°ç¨‹åº]
    D --> E[å°ç¨‹åºæ¥æ”¶base64æ•°æ®]
    E --> F[å°ç¨‹åºä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°]
    F --> G[æ›´æ–°ç•Œé¢æ˜¾ç¤ºçœŸå®å›¾ç‰‡]
```

## ğŸ› ï¸ æ ¸å¿ƒä¿®æ”¹

### 1. æœåŠ¡ç«¯ä¿®æ”¹ (server.py)

#### ç§»é™¤é™æ€æ–‡ä»¶æœåŠ¡
```python
# æ³¨é‡Šæ‰å›¾ç‰‡å­˜å‚¨ç›®å½•å’Œé™æ€æ–‡ä»¶æœåŠ¡
# IMAGES_DIR = Path("fruit_images")
# IMAGES_DIR.mkdir(exist_ok=True)
# app.mount("/images", StaticFiles(directory=str(IMAGES_DIR)), name="images")
```

#### ä¿®æ”¹å›¾ç‰‡å¤„ç†é€»è¾‘
```python
async def handle_fruit_detection_result(robot_id, message):
    """å¤„ç†æ°´æœè¯†åˆ«ç»“æœ"""
    try:
        detection_data = message.get("data", {})
        timestamp = message.get("timestamp", int(time.time() * 1000))
        
        # å¤„ç†å›¾ç‰‡æ•°æ® - ç›´æ¥ä¼ è¾“base64æ•°æ®ç»™å°ç¨‹åº
        image_base64 = None
        if "image_base64" in detection_data and detection_data["image_base64"]:
            try:
                # ä¿ç•™åŸå§‹çš„base64æ•°æ®ï¼Œè®©å°ç¨‹åºè‡ªå·±å¤„ç†
                image_base64 = detection_data["image_base64"]
                
                # ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡IDï¼Œä¾›å°ç¨‹åºä¿å­˜æ—¶ä½¿ç”¨
                image_id = f"fruit_{robot_id}_{timestamp}"
                
                # æ›´æ–°detection_dataï¼Œä¼ é€’base64æ•°æ®è€Œä¸æ˜¯URL
                detection_data["imageBase64"] = image_base64  # å›¾ç‰‡çš„base64æ•°æ®
                detection_data["imageId"] = image_id  # å›¾ç‰‡å”¯ä¸€æ ‡è¯†
                detection_data["imageFormat"] = "jpg"  # å›¾ç‰‡æ ¼å¼
                
                logger.info(f"å›¾ç‰‡base64æ•°æ®å‡†å¤‡å®Œæˆï¼ŒID: {image_id}, å¤§å°: {len(image_base64)} å­—ç¬¦")
                
            except Exception as e:
                logger.error(f"å¤„ç†å›¾ç‰‡base64æ•°æ®å¤±è´¥: {e}")
                image_base64 = None
        
        # ... å…¶ä»–å¤„ç†é€»è¾‘
```

### 2. å¾®ä¿¡å°ç¨‹åºä¿®æ”¹ (detection.js)

#### æ–°å¢base64å›¾ç‰‡ä¿å­˜åŠŸèƒ½
```javascript
/**
 * ä¿å­˜base64å›¾ç‰‡æ•°æ®åˆ°æœ¬åœ°
 * @param {Object} result - è¯†åˆ«ç»“æœå¯¹è±¡
 * @returns {Promise<string>} ä¿å­˜åçš„æœ¬åœ°è·¯å¾„
 */
saveBase64ImageToLocal: function(result) {
  return new Promise((resolve, reject) => {
    if (!result.imageBase64) {
      reject(new Error('æ²¡æœ‰å›¾ç‰‡æ•°æ®'));
      return;
    }

    try {
      // ç”Ÿæˆæœ¬åœ°æ–‡ä»¶å
      const fileName = `${result.imageId}.${result.imageFormat}`;
      const tempFilePath = `${wx.env.USER_DATA_PATH}/${fileName}`;
      
      // å°†base64æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶
      const fs = wx.getFileSystemManager();
      
      // ç§»é™¤base64å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
      let base64Data = result.imageBase64;
      if (base64Data.startsWith('data:')) {
        base64Data = base64Data.split(',')[1];
      }
      
      // å†™å…¥æ–‡ä»¶
      fs.writeFile({
        filePath: tempFilePath,
        data: base64Data,
        encoding: 'base64',
        success: (res) => {
          // ä¿å­˜åˆ°æ°¸ä¹…å­˜å‚¨
          wx.saveFile({
            tempFilePath: tempFilePath,
            success: (saveRes) => {
              // æ›´æ–°æœ¬åœ°å›¾ç‰‡è®°å½•
              this.updateLocalImageRecord(fileName, saveRes.savedFilePath, result);
              resolve(saveRes.savedFilePath);
            },
            fail: (saveError) => {
              // å³ä½¿æ°¸ä¹…ä¿å­˜å¤±è´¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸´æ—¶è·¯å¾„
              resolve(tempFilePath);
            }
          });
        },
        fail: (writeError) => {
          reject(writeError);
        }
      });
      
    } catch (error) {
      reject(error);
    }
  });
}
```

#### ä¿®æ”¹è¯†åˆ«ç»“æœå¤„ç†
```javascript
formatServerDetectionResult: function(serverData) {
  // ... å…¶ä»–å¤„ç†é€»è¾‘
  
  const result = {
    // ... å…¶ä»–å­—æ®µ
    imageBase64: data.imageBase64 || '',  // æœåŠ¡å™¨ä¼ æ¥çš„base64æ•°æ®
    imageId: data.imageId || detectionId,  // å›¾ç‰‡å”¯ä¸€æ ‡è¯†
    imageFormat: data.imageFormat || 'jpg',  // å›¾ç‰‡æ ¼å¼
    imageUrl: '',  // åˆå§‹ä¸ºç©ºï¼Œä¿å­˜åä¼šæ›´æ–°
    isLocalImage: true,  // æ ‡è®°ä¸ºæœ¬åœ°å›¾ç‰‡
    needsSaveImage: !!data.imageBase64  // æ˜¯å¦éœ€è¦ä¿å­˜å›¾ç‰‡
  };
  
  // å¦‚æœæœ‰base64å›¾ç‰‡æ•°æ®ï¼Œä¿å­˜åˆ°æœ¬åœ°
  if (result.needsSaveImage) {
    this.saveBase64ImageToLocal(result).then(savedPath => {
      // æ›´æ–°å†å²è®°å½•ä¸­çš„å›¾ç‰‡è·¯å¾„
      this.updateImagePathInHistory(result.id, savedPath);
    }).catch(error => {
      // ä½¿ç”¨é¢„è®¾å›¾ç‰‡ä½œä¸ºå¤‡é€‰
      const fallbackPath = this.getLocalFruitImage(result.fruitType);
      this.updateImagePathInHistory(result.id, fallbackPath);
    });
  }
  
  return result;
}
```

## ğŸ“Š æ•°æ®æ ¼å¼

### æœåŠ¡ç«¯å‘é€æ ¼å¼
```json
{
  "type": "fruit_detection_result",
  "data": {
    "fruitType": "å˜å•¦è‹¹æœ",
    "maturity": 85,
    "qualityScore": 80,
    "confidence": 90,
    "healthStatus": "å¥åº·",
    "recommendation": "æœå®æˆç†Ÿåº¦é«˜ï¼Œå¤–è§‚æ— æ˜¾è‘—ç¼ºé™·ï¼Œå»ºè®®é‡‡æ‘˜",
    "imageBase64": "/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=",
    "imageId": "fruit_robot_123_1749906247486",
    "imageFormat": "jpg",
    "timestamp": 1749906247486,
    "detectionTime": "09:04",
    "location": "è‹¹æœå›­åŒº3å·åœ°å— I-94 åŒºåŸŸ"
  },
  "timestamp": 1749906247486
}
```

### å°ç¨‹åºæœ¬åœ°å­˜å‚¨æ ¼å¼
```json
{
  "id": "detection_1749906247486_00005_2x7xuds15",
  "fruitType": "å˜å•¦è‹¹æœ",
  "imageUrl": "wxfile://tmp_xxx/fruit_robot_123_1749906247486.jpg",
  "localImagePath": "wxfile://tmp_xxx/fruit_robot_123_1749906247486.jpg",
  "isLocalImage": true,
  "imageName": "æœåŠ¡å™¨å›¾ç‰‡",
  "timestamp": 1749906247486
}
```

## ğŸ¯ ä¼˜åŠ¿åˆ†æ

| ç‰¹æ€§ | ä¹‹å‰æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ âœ… |
|------|----------|----------|
| æœåŠ¡ç«¯å¤æ‚åº¦ | éœ€è¦æ–‡ä»¶ç®¡ç† | ç®€å•æ•°æ®ä¼ è¾“ |
| ç½‘ç»œé…ç½® | éœ€è¦IPé…ç½® | æ— éœ€é…ç½® |
| å›¾ç‰‡è®¿é—® | ä¾èµ–ç½‘ç»œè¯·æ±‚ | æœ¬åœ°ç›´æ¥è®¿é—® |
| å­˜å‚¨ç®¡ç† | æœåŠ¡ç«¯å­˜å‚¨ | å°ç¨‹åºæœ¬åœ°ç®¡ç† |
| ç¦»çº¿å¯ç”¨æ€§ | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ |
| ä¼ è¾“æ•ˆç‡ | éœ€è¦äºŒæ¬¡è¯·æ±‚ | ä¸€æ¬¡ä¼ è¾“å®Œæˆ |

## ğŸ”§ ä½¿ç”¨æ­¥éª¤

### 1. æ›´æ–°æœåŠ¡ç«¯ä»£ç 
- æ³¨é‡Šæ‰é™æ€æ–‡ä»¶æœåŠ¡ç›¸å…³ä»£ç 
- ä¿®æ”¹ `handle_fruit_detection_result` å‡½æ•°
- ç¡®ä¿ä¼ è¾“ `imageBase64`ã€`imageId`ã€`imageFormat` å­—æ®µ

### 2. æ›´æ–°å°ç¨‹åºä»£ç 
- æ·»åŠ  `saveBase64ImageToLocal` å‡½æ•°
- ä¿®æ”¹ `formatServerDetectionResult` å‡½æ•°
- æ·»åŠ å›¾ç‰‡ç¼“å­˜ç®¡ç†åŠŸèƒ½

### 3. æµ‹è¯•éªŒè¯
```javascript
// åœ¨å°ç¨‹åºæ§åˆ¶å°æµ‹è¯•
const page = getCurrentPages()[0];
console.log('æœ¬åœ°å›¾ç‰‡åˆ—è¡¨:', page.getLocalImageList());
```

## ğŸ“± ç•Œé¢æ•ˆæœ

### æ˜¾ç¤ºç‰¹å¾
- âœ… çœŸå®çš„æ°´æœå›¾ç‰‡ï¼ˆæ¥è‡ªæœåŠ¡ç«¯ï¼‰
- âœ… "æœ¬åœ°"æ ‡è¯†æ˜¾ç¤º
- âœ… å¿«é€ŸåŠ è½½ï¼Œæ— ç½‘ç»œå»¶è¿Ÿ
- âœ… ç¦»çº¿å¯ç”¨

### è°ƒè¯•ä¿¡æ¯
```
æœåŠ¡å™¨å›¾ç‰‡å¤„ç†:
- æ°´æœç±»å‹: å˜å•¦è‹¹æœ
- æ˜¯å¦æœ‰base64æ•°æ®: true
- å›¾ç‰‡ID: fruit_robot_123_1749906247486
- æ ¼å¼åŒ–å®Œæˆ - æœ€ç»ˆç»“æœfruitType: å˜å•¦è‹¹æœ

å¼€å§‹ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°: fruit_robot_123_1749906247486.jpg
å›¾ç‰‡å†™å…¥æˆåŠŸ: wxfile://tmp_xxx/fruit_robot_123_1749906247486.jpg
å›¾ç‰‡ä¿å­˜åˆ°æ°¸ä¹…å­˜å‚¨æˆåŠŸ: wxfile://store_xxx/fruit_robot_123_1749906247486.jpg
æ›´æ–°è®°å½• detection_xxx çš„å›¾ç‰‡è·¯å¾„: wxfile://store_xxx/fruit_robot_123_1749906247486.jpg
```

## ğŸ› ï¸ ç»´æŠ¤åŠŸèƒ½

### è‡ªåŠ¨æ¸…ç†
- 7å¤©åè‡ªåŠ¨åˆ é™¤è¿‡æœŸå›¾ç‰‡
- é™åˆ¶æœ€å¤§ä¿å­˜50å¼ å›¾ç‰‡
- é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¸…ç†

### æ‰‹åŠ¨ç®¡ç†
```javascript
// è·å–æœ¬åœ°å›¾ç‰‡åˆ—è¡¨
const images = page.getLocalImageList();

// æ‰‹åŠ¨æ¸…ç†è¿‡æœŸå›¾ç‰‡
page.cleanupLocalImages();

// æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
console.log(`å½“å‰ä¿å­˜äº† ${images.length} å¼ å›¾ç‰‡`);
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **æœåŠ¡ç«¯éƒ¨ç½²**ï¼š
   - æ›´æ–° `server.py` æ–‡ä»¶
   - é‡å¯æœåŠ¡ç«¯ç¨‹åº
   - éªŒè¯ä¸å†åˆ›å»º `fruit_images` ç›®å½•

2. **å°ç¨‹åºéƒ¨ç½²**ï¼š
   - æ›´æ–° `detection.js` æ–‡ä»¶
   - é‡æ–°ç¼–è¯‘å°ç¨‹åº
   - æµ‹è¯•å›¾ç‰‡æ¥æ”¶å’Œä¿å­˜åŠŸèƒ½

3. **éªŒè¯æ•ˆæœ**ï¼š
   - å‘é€æµ‹è¯•è¯†åˆ«ç»“æœ
   - æ£€æŸ¥å°ç¨‹åºæ˜¯å¦æ˜¾ç¤ºçœŸå®å›¾ç‰‡
   - ç¡®è®¤å›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

ç°åœ¨æ‚¨çš„ç³»ç»Ÿå°†å®Œå…¨é€šè¿‡base64æ•°æ®ä¼ è¾“å›¾ç‰‡ï¼ŒæœåŠ¡ç«¯æ›´ç®€æ´ï¼Œå°ç¨‹åºæ˜¾ç¤ºçœŸå®å›¾ç‰‡ï¼ 